<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>METAComPNG v29.6 (Robust Loading Fix)</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Zen+Maru+Gothic:wght@700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { corePlugins: { preflight: true } }
    </script>
    <style>
        [v-cloak] { display: none; }
        body { font-family: sans-serif; display: flex; flex-direction: column; min-height: 100vh; }
        .drag-active { border-color: #3b82f6; background-color: #eff6ff; }
        td, th { padding: 0.5rem; font-size: 0.75rem; border-bottom: 1px solid #e5e7eb; vertical-align: top; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }

        /* Logo Styles */
        .logo-jp { font-family: 'Zen Maru Gothic', sans-serif; fill: #fff; font-size: 34px; font-weight: bold; text-anchor: middle; }
        .logo-en { font-family: 'Fredoka One', cursive; font-size: 20px; text-anchor: middle; letter-spacing: 1px; }
        .fill-meta { fill: #a78bfa; } 
        .fill-com  { fill: #22d3ee; } 
        .fill-png  { fill: #fb923c; } 
        .logo-sub { font-family: sans-serif; fill: #94a3b8; font-size: 8px; font-weight: bold; letter-spacing: 0.5px; text-anchor: middle; }
        .logo-wire { fill: none; stroke: #64748b; stroke-width: 3; stroke-linecap: round; }
        .logo-wire-active { stroke: #a78bfa; stroke-dasharray: 6 4; animation: flow 1s linear infinite; }
        @keyframes flow { to { stroke-dashoffset: -10; } }

        /* Thumbnails */
        .thumb-wrap { position: relative; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; background: #f1f5f9; border-radius: 4px; border: 1px solid #e2e8f0; cursor: pointer; }
        .thumb-img { width: 100%; height: 100%; object-fit: cover; border-radius: 3px; }
        .thumb-placeholder { font-size: 10px; color: #94a3b8; text-align: center; line-height: 1.2; font-weight: bold; }

        /* Floating Preview */
        .float-preview {
            position: fixed; z-index: 9999; pointer-events: none;
            background: white; border: 1px solid #cbd5e1; border-radius: 4px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); padding: 2px;
            max-width: 400px; max-height: 400px; object-fit: contain;
            transition: opacity 0.1s;
        }

        /* Filter Buttons */
        .btn-tag { transition: all 0.1s; border: 1px solid transparent; }
        .state-off { background-color: #f8fafc; color: #64748b; border-color: #e2e8f0; }
        .state-include { background-color: #3b82f6; color: white; border-color: #2563eb; }
        .state-include-or { background-color: #f97316; color: white; border-color: #ea580c; }
        .state-exclude { background-color: #ef4444; color: white; border-color: #dc2626; }
        
        .trans-btn { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border-radius: 50%; background-color: #e2e8f0; color: #64748b; font-size: 9px; font-weight: bold; margin-left: 4px; cursor: pointer; text-decoration: none; }
        .trans-btn:hover { background-color: #3b82f6; color: white; }

        .word-btn { display: inline-block; padding: 0 2px; margin: 0 1px; border-radius: 2px; cursor: pointer; transition: background 0.1s; border: 1px solid transparent; }
        .word-btn:hover { background-color: #e2e8f0; border-color: #cbd5e1; color: #2563eb; }
        .word-btn.active-filter { background-color: #bfdbfe; color: #1e40af; border-color: #60a5fa; }
        
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { color: #2563eb; background-color: #f1f5f9; }
        
        .prompt-container { position: relative; height: 100%; min-height: 60px; }
        .prompt-text-area { max-height: 120px; overflow-y: auto; padding-right: 20px; } 
        .copy-btn-cell { position: absolute; top: 0; right: 0; background: rgba(255,255,255,0.8); border: 1px solid #cbd5e1; border-radius: 4px; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #64748b; font-size: 10px; z-index: 10; }
        .copy-btn-cell:hover { background: #3b82f6; color: white; border-color: #2563eb; }
        .edit-btn-cell { position: absolute; top: 0; right: 24px; background: rgba(255,255,255,0.8); border: 1px solid #cbd5e1; border-radius: 4px; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #64748b; font-size: 10px; z-index: 10; }
        .edit-btn-cell:hover { background: #f59e0b; color: white; border-color: #d97706; }

        .filename-cell { position: relative; cursor: pointer; }
        .filename-cell:hover { color: #2563eb; background-color: #eff6ff; }
        .filename-cell:hover::after {
            content: "üìã"; position: absolute; right: 4px; top: 50%; transform: translateY(-50%); font-size: 10px; opacity: 0.7;
        }
        
        .db-status { font-size: 10px; padding: 2px 8px; border-radius: 12px; background: #f1f5f9; color: #64748b; margin-left: 8px; font-weight: bold; transition: all 0.3s; }
        .db-status.busy { background: #fee2e2; color: #ef4444; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .fav-btn { cursor: pointer; font-size: 1.2rem; line-height: 1; user-select: none; transition: transform 0.1s; }
        .fav-btn:hover { transform: scale(1.2); }
        .fav-none { color: #cbd5e1; }
        .fav-star { color: #fbbf24; }
        .fav-heart { color: #f43f5e; }
        .fav-flag { color: #10b981; }

        .scroll-top-btn {
            position: fixed; bottom: 20px; right: 20px;
            width: 40px; height: 40px;
            background-color: #3b82f6; color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer; opacity: 0; pointer-events: none;
            transition: all 0.3s; z-index: 100;
        }
        .scroll-top-btn.show { opacity: 1; pointer-events: auto; }
        .scroll-top-btn:hover { background-color: #2563eb; transform: translateY(-2px); }

        .text-size-sm { font-size: 12px; }
        .text-size-md { font-size: 14px; }
        .text-size-lg { font-size: 16px; }
        .tag-p-sm { padding: 2px 8px; }
        .tag-p-md { padding: 4px 10px; }
        .tag-p-lg { padding: 6px 12px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
    <div id="app" v-cloak class="p-4 max-w-[98%] mx-auto flex-grow w-full">
        
        <img v-if="hoverImage.src" :src="hoverImage.src" class="float-preview" :style="hoverImage.style">
        <input type="file" ref="fileInput" multiple @change="handleFiles" class="hidden">
        <input type="file" ref="folderInput" webkitdirectory directory multiple @change="handleFiles" class="hidden">

        <div class="scroll-top-btn" :class="{ 'show': showScrollBtn }" @click="scrollToTop">‚ñ≤</div>

        <header class="mb-4 bg-white rounded shadow-sm border border-slate-200 sticky top-0 z-30 overflow-hidden">
            <div class="bg-slate-700 p-2 flex justify-center sm:justify-start">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 380 100" class="h-20 w-auto">
                    <rect width="380" height="100" rx="10" fill="#334155" opacity="0"/> 
                    <g transform="translate(40, 20)">
                        <rect x="0" y="0" width="50" height="60" rx="8" fill="#f8fafc" stroke="#94a3b8" stroke-width="2"/>
                        <path d="M0 8 C0 4 4 0 8 0 L42 0 C46 0 50 4 50 8 L50 15 L0 15 Z" fill="#3b82f6" opacity="0.8"/>
                        <circle cx="15" cy="35" r="2" fill="#334155"/>
                        <circle cx="35" cy="35" r="2" fill="#334155"/>
                        <path d="M22 42 Q25 45 28 42" fill="none" stroke="#334155" stroke-width="1.5" stroke-linecap="round"/>
                        <circle cx="-5" cy="20" r="4" fill="#ef4444"/>
                        <circle cx="-5" cy="40" r="4" fill="#22c55e"/>
                        <circle cx="55" cy="30" r="4" fill="#a78bfa"/>
                    </g>
                    <path d="M95 50 C 110 50, 110 55, 125 55" class="logo-wire logo-wire-active" />
                    <circle cx="125" cy="55" r="3" fill="#a78bfa"/>
                    <g transform="translate(0, 0)">
                        <g transform="translate(165, 0)"><text x="0" y="52" class="logo-jp">„ÇÅ„Åü</text><text x="0" y="75" class="logo-en fill-meta">META</text><text x="0" y="92" class="logo-sub">ComfyUI</text></g>
                        <g transform="translate(240, 0)"><text x="0" y="52" class="logo-jp">„Åì„Çì</text><text x="0" y="75" class="logo-en fill-com">Com</text><text x="0" y="92" class="logo-sub">Metadata</text></g>
                        <g transform="translate(315, 0)"><text x="0" y="52" class="logo-jp">„Å¥„Çì</text><text x="0" y="75" class="logo-en fill-png">PNG</text><text x="0" y="92" class="logo-sub">Analyzer</text></g>
                    </g>
                </svg>
            </div>

            <div class="p-4 flex flex-wrap justify-between items-center gap-4 border-t border-slate-200">
                <div class="flex items-center gap-2 border-r border-slate-200 pr-4 mr-2">
                    <button @click="triggerDbLoad" class="flex items-center gap-1 bg-slate-700 hover:bg-slate-800 text-white px-3 py-1.5 rounded text-xs transition shadow-sm">
                        üìÇ <span class="hidden sm:inline">DBË™≠Ëæº</span>
                    </button>
                    <input type="file" ref="dbInput" @change="loadDB" accept=".json" class="hidden">
                    <button @click="saveDB" :disabled="images.length === 0 || loading" class="flex items-center gap-1 bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded text-xs transition shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">
                        üíæ <span class="hidden sm:inline">DB‰øùÂ≠ò</span>
                    </button>
                    <a href="manual.html" target="_blank" class="flex items-center gap-1 bg-slate-100 hover:bg-blue-100 text-slate-600 hover:text-blue-700 px-3 py-1.5 rounded text-xs transition border border-slate-300 ml-2" title="Êìç‰Ωú„Éû„Éã„É•„Ç¢„É´„ÇíÈñã„Åè">‚ùì ‰Ωø„ÅÑÊñπ</a>
                    <span v-if="dbStatus" class="db-status">{{ dbStatus }}</span>
                </div>

                <div class="flex items-center gap-3 flex-grow" v-if="images.length > 0">
                    <div class="flex items-center bg-slate-100 rounded px-3 py-1.5 border border-slate-200">
                        <span class="text-xs font-bold mr-2 text-slate-600">ÈÅ∏Êäû: {{ selectedCount }} / {{ images.length }}</span>
                        <button @click="copySelected" :disabled="selectedCount===0" class="text-xs bg-white border border-slate-300 px-2 py-1 rounded hover:bg-blue-50 hover:text-blue-600 disabled:opacity-50 transition mr-2">üìã „Ç≥„Éî„Éº</button>
                        <button @click="exportSelectedCSV" :disabled="selectedCount===0" class="text-xs bg-white border border-slate-300 px-2 py-1 rounded hover:bg-green-50 hover:text-green-600 disabled:opacity-50 transition">üíæ CSV</button>
                    </div>
                    <label class="flex items-center space-x-2 text-xs font-bold text-slate-600 cursor-pointer hover:bg-slate-100 px-2 py-1 rounded">
                        <input type="checkbox" v-model="filterBySelection" class="rounded text-blue-600">
                        <span>ÈÅ∏Êäû„ÅÆ„Åø</span>
                    </label>
                </div>
                
                <div class="flex items-center gap-2">
                    <button @click="clearAll" class="bg-slate-500 hover:bg-slate-600 text-white px-3 py-1.5 rounded text-xs transition">„ÇØ„É™„Ç¢</button>
                    <button @click="exportCSV" v-if="images.length > 0" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-xs transition">ÂÖ®CSV</button>
                    <button @click="debugIndexedDB" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded text-xs transition" title="IndexedDB„ÅÆÂÜÖÂÆπ„Çí„Ç≥„É≥„ÇΩ„Éº„É´„Å´Âá∫Âäõ">üêõ Debug DB</button>
                </div>
            </div>
        </header>

        <div v-if="errorMessage" class="mb-4 p-4 bg-red-100 border border-red-300 text-red-800 rounded text-sm shadow-sm">
            <div class="flex justify-between items-start">
                <div>
                    <strong class="block mb-1 text-red-900">‚ö†Ô∏è „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü:</strong>
                    <pre class="whitespace-pre-wrap font-mono text-xs">{{ errorMessage }}</pre>
                </div>
                <button @click="errorMessage = ''" class="text-red-500 hover:text-red-700 font-bold px-2">√ó</button>
            </div>
        </div>
        <div v-if="copyMessage" class="fixed bottom-4 right-4 bg-slate-800 text-white px-4 py-2 rounded shadow-lg z-50 animate-bounce text-sm">{{ copyMessage }}</div>

        <!-- Drop Zones -->
        <div v-if="images.length === 0" 
            @dragover.prevent="isDragging = true" @dragleave.prevent="isDragging = false" @drop.prevent="handleDrop"
            :class="{'drag-active': isDragging}" class="border-2 border-dashed border-slate-300 rounded-lg p-10 text-center cursor-pointer bg-white transition mb-4 min-h-[200px] flex flex-col justify-center items-center group hover:border-blue-400 hover:text-blue-500">
            <p v-if="loading" class="text-blue-600 font-bold text-lg animate-pulse">Âá¶ÁêÜ‰∏≠... ({{ processStatus }})</p>
            <div v-else>
                <div class="text-5xl mb-4 group-hover:scale-110 transition duration-300">üì•</div>
                <p class="text-slate-500 text-lg mb-2 font-bold group-hover:text-blue-500">„Åì„Åì„Å´PNGÁîªÂÉè / „Éï„Ç©„É´„ÉÄ / DB„Çí„Éâ„É≠„ÉÉ„Éó</p>
                <div class="flex gap-2 justify-center mt-2">
                    <button @click="triggerFileSelect" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-xs hover:bg-blue-200 transition">„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</button>
                    <button @click="triggerFolderSelect" class="bg-orange-100 text-orange-700 px-3 py-1 rounded text-xs hover:bg-orange-200 transition">„Éï„Ç©„É´„ÉÄ„ÇíÈÅ∏Êäû</button>
                </div>
                <p class="text-slate-400 text-xs mt-2">„Éñ„É©„Ç¶„Ç∂„ÇíÈñâ„Åò„Å¶„ÇÇ„Éá„Éº„Çø„ÅØËá™Âãï‰øùÂ≠ò„Åï„Çå„Åæ„Åô</p>
            </div>
        </div>
        <div v-else 
            @dragover.prevent="isDragging = true" @dragleave.prevent="isDragging = false" @drop.prevent="handleDrop"
            :class="{'bg-blue-50 border-blue-400 text-blue-600 scale-[1.01] shadow-md': isDragging, 'bg-white border-slate-300 text-slate-500': !isDragging}"
            class="border-2 border-dashed rounded-lg p-4 text-center cursor-pointer transition mb-4 hover:border-blue-400 hover:text-blue-600 flex justify-center items-center gap-2 duration-200">
            <span v-if="loading" class="font-bold text-blue-600 animate-pulse">Âá¶ÁêÜ‰∏≠... ({{ processStatus }})</span>
            <div v-else class="flex items-center gap-4">
                <span class="text-sm font-bold flex items-center gap-2" @click="triggerFileSelect"><span class="text-xl">‚ûï</span> ËøΩÂä†: ÁîªÂÉè/DB„Çí„Éâ„É≠„ÉÉ„Éó</span>
                <span class="text-xs text-slate-300">|</span>
                <button @click="triggerFolderSelect" class="text-xs bg-orange-50 text-orange-600 px-2 py-1 rounded hover:bg-orange-100 border border-orange-200">üìÇ „Éï„Ç©„É´„ÉÄÈÅ∏Êäû</button>
            </div>
        </div>

        <!-- Analysis Panel -->
        <div v-if="images.length > 0" class="bg-white p-4 rounded shadow-sm mb-4 border border-slate-200">
            <div class="flex justify-between items-center mb-2">
                <h2 class="font-bold text-slate-700 text-sm flex items-center gap-2"><span>üìä ÂàÜÊûê & „Éï„Ç£„É´„Çø</span></h2>
                <button @click="showAnalysis = !showAnalysis" class="text-xs bg-indigo-50 text-indigo-700 px-3 py-1 rounded hover:bg-indigo-100 border border-indigo-200 transition">{{ showAnalysis ? '‚ñº Èñâ„Åò„Çã' : '‚ñ∂ „Éï„Ç£„É´„Çø„Éë„Éç„É´„ÇíÈñã„Åè' }}</button>
            </div>
            <div v-show="showAnalysis" class="mt-4 space-y-4 animate-fade-in">
                <!-- Tag Search -->
                <div class="flex flex-wrap items-center gap-4 bg-slate-50 p-2 rounded border border-slate-200">
                    <div class="flex items-center gap-2 flex-grow">
                        <span class="text-xs font-bold text-slate-500">üîç „Çø„Ç∞Ê§úÁ¥¢:</span>
                        <input type="text" v-model="tagSearchQuery" placeholder="„Çø„Ç∞Âêç„ÇíÂÖ•Âäõ..." class="border border-slate-300 rounded px-2 py-1 text-xs w-full max-w-xs focus:ring-2 focus:ring-blue-400 outline-none">
                    </div>
                    <label class="flex items-center gap-2 cursor-pointer text-xs font-bold text-slate-600 select-none">
                        <input type="checkbox" v-model="showAllTags" class="rounded text-blue-600">
                        <span>Áµû„ÇäËæº„Åø‰∏≠„ÇÇÂÖ®„Çø„Ç∞„ÇíË°®Á§∫ÔºàORÊ§úÁ¥¢Áî®Ôºâ</span>
                    </label>
                </div>

                <!-- Metadata Categories -->
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4 p-3 rounded border border-slate-100">
                    <!-- Fav Filter -->
                    <div>
                        <div class="flex justify-between items-center border-b pb-1 mb-1">
                            <h3 class="text-[10px] uppercase font-bold text-slate-500">FAV</h3>
                        </div>
                        <div class="flex flex-wrap gap-1">
                            <button @click="toggleFilter('fav', 'star')" :class="getFilterClass('fav', 'star')" class="px-2 py-0.5 rounded text-[10px] btn-tag">‚òÖ Star</button>
                            <button @click="toggleFilter('fav', 'heart')" :class="getFilterClass('fav', 'heart')" class="px-2 py-0.5 rounded text-[10px] btn-tag">‚ô• Heart</button>
                            <button @click="toggleFilter('fav', 'flag')" :class="getFilterClass('fav', 'flag')" class="px-2 py-0.5 rounded text-[10px] btn-tag">üö© Flag</button>
                        </div>
                    </div>
                    
                    <div><div class="flex justify-between items-center border-b pb-1 mb-1"><h3 class="text-[10px] uppercase font-bold text-slate-500">TOOL</h3></div><div class="flex flex-wrap gap-1 max-h-24 overflow-y-auto content-start"><button v-for="item in metadataLists.tool" :key="item.name" @click="toggleFilter('tool', item.name)" :class="getFilterClass('tool', item.name)" class="px-2 py-0.5 rounded text-[10px] btn-tag truncate max-w-full">{{ item.name }} <span class="opacity-50">({{ item.count }})</span></button></div></div>
                    <div v-for="(list, key) in { model: metadataLists.model, lora: metadataLists.lora, sampler: metadataLists.sampler, scheduler: metadataLists.scheduler }" :key="key">
                        <div class="flex justify-between items-center border-b pb-1 mb-1"><h3 class="text-[10px] uppercase font-bold text-slate-500">{{ key }}</h3><button v-if="key==='lora'" @click="toggleMode('lora')" class="text-[9px] px-1.5 py-0.5 rounded text-white font-bold transition" :class="filters.lora.mode === 'and' ? 'bg-blue-500' : 'bg-orange-500'">{{ filters.lora.mode.toUpperCase() }}</button></div>
                        <div class="flex flex-wrap gap-1 max-h-24 overflow-y-auto content-start"><button v-for="item in list" :key="item.name" @click="toggleFilter(key, item.name)" :class="getFilterClass(key, item.name)" class="px-2 py-0.5 rounded text-[10px] btn-tag truncate max-w-full">{{ item.name }} <span class="opacity-50">({{ item.count }})</span></button></div>
                    </div>
                </div>

                <!-- Prompt Tags -->
                <div>
                    <div class="flex items-center gap-3 mb-2 border-b pb-1">
                        <h3 class="text-xs font-bold text-slate-600">Positive Prompt Words</h3>
                        <div class="flex items-center gap-2">
                             <span class="text-[9px] font-bold text-slate-400">ÊñáÂ≠ó„Çµ„Ç§„Ç∫:</span>
                             <button @click="tagFontSize = 'sm'" :class="{'bg-slate-300 text-white': tagFontSize==='sm', 'bg-slate-100 text-slate-500': tagFontSize!=='sm'}" class="px-2 py-0.5 rounded text-[9px] font-bold transition">Â∞è</button>
                             <button @click="tagFontSize = 'md'" :class="{'bg-slate-300 text-white': tagFontSize==='md', 'bg-slate-100 text-slate-500': tagFontSize!=='md'}" class="px-2 py-0.5 rounded text-[9px] font-bold transition">‰∏≠</button>
                             <button @click="tagFontSize = 'lg'" :class="{'bg-slate-300 text-white': tagFontSize==='lg', 'bg-slate-100 text-slate-500': tagFontSize!=='lg'}" class="px-2 py-0.5 rounded text-[9px] font-bold transition">Â§ß</button>
                        </div>
                        <button @click="toggleMode('prompt')" class="text-[10px] px-2 py-0.5 rounded text-white font-bold transition shadow-sm ml-auto" :class="filters.prompt.mode === 'and' ? 'bg-blue-500 hover:bg-blue-600' : 'bg-orange-500 hover:bg-orange-600'">Êù°‰ª∂: {{ filters.prompt.mode === 'and' ? 'AND' : 'OR' }}</button>
                        <button @click="copyActiveTags" class="text-[10px] bg-white border border-slate-300 px-2 py-0.5 rounded hover:bg-slate-100 flex items-center gap-1" title="„Éï„Ç£„É´„Çø‰∏≠„ÅÆ„Çø„Ç∞„Çí„Ç´„É≥„ÉûÂå∫Âàá„Çä„Åß„Ç≥„Éî„Éº">üìã „Çø„Ç∞‰∏ÄË¶ß„Çí„Ç≥„Éî„Éº</button>
                        <span v-if="tagSearchQuery" class="text-xs text-blue-600 font-bold">"{{ tagSearchQuery }}" „ÅÆÊ§úÁ¥¢ÁµêÊûú</span>
                    </div>
                    <div class="flex flex-wrap gap-1.5 max-h-96 overflow-y-auto p-2 bg-white rounded border border-slate-200 shadow-inner">
                        <div v-for="tag in visibleTags" :key="tag.word" class="flex items-center">
                            <button @click="toggleFilter('prompt', tag.word)" :class="[getFilterClass('prompt', tag.word), `text-size-${tagFontSize}`, `tag-p-${tagFontSize}`]" class="rounded-l btn-tag flex items-center gap-1 rounded-r-none border-r-0">{{ tag.word }} <span class="bg-black/5 px-1 rounded-full text-[10px]">{{ tag.count }}</span></button>
                            <a :href="`https://translate.google.com/?sl=en&tl=ja&text=${encodeURIComponent(tag.word)}&op=translate`" target="_blank" class="trans-btn" title="GoogleÁøªË®≥„ÅßÈñã„Åè">Ë®≥</a>
                        </div>
                        <div v-if="visibleTags.length === 0" class="text-xs text-slate-400 p-2">Ë©≤ÂΩì„Åô„Çã„Çø„Ç∞„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                        <button v-if="!tagSearchQuery && tagsLimited && tagList.length > 100" @click="tagsLimited = false" class="px-2 py-0.5 text-xs text-blue-600 hover:underline">...ÊÆã„Çä{{ tagList.length - 100 }}ÂçòË™û„ÇíË°®Á§∫</button>
                    </div>
                </div>
            </div>
            
            <div v-if="hasActiveFilters" class="mt-2 pt-2 border-t border-slate-100 flex flex-wrap gap-2 text-xs items-center"><span class="font-bold text-slate-500">Filters:</span><template v-for="(states, type) in filters" :key="type"><span v-for="val in states.include" class="px-2 py-0.5 rounded border flex items-center gap-1" :class="filters[type].mode === 'and' ? 'bg-blue-100 text-blue-700 border-blue-200' : 'bg-orange-100 text-orange-800 border-orange-200'">{{ type }}:{{ val }} <span class="text-[9px] opacity-70 ml-0.5 font-bold">({{ filters[type].mode.toUpperCase() }})</span><button @click="removeFilter(type, val, 'include')" class="hover:text-black font-bold ml-1">√ó</button></span><span v-for="val in states.exclude" class="bg-red-100 text-red-700 px-2 py-0.5 rounded border border-red-200 flex items-center gap-1">NOT {{ type }}:{{ val }} <button @click="removeFilter(type, val, 'exclude')" class="hover:text-red-900 font-bold">√ó</button></span></template><button @click="resetFilters" class="ml-auto text-slate-400 underline hover:text-red-500">ÂÖ®Ëß£Èô§</button></div>
        </div>

        <div v-if="images.length > 0" class="bg-white rounded shadow-sm overflow-x-auto border border-slate-200 pb-10">
            <table class="w-full text-left border-collapse table-fixed min-w-[1300px]">
                <thead class="bg-slate-50 text-slate-600 sticky top-0 z-20 shadow-sm text-[10px] uppercase font-bold tracking-wider">
                    <tr>
                        <th class="w-8 text-center bg-slate-50"><input type="checkbox" @change="toggleAllSelection" :checked="isAllSelected" class="align-middle"></th>
                        <th class="w-8 bg-slate-50 text-center">Fav</th>
                        <th class="w-16 bg-slate-50">Thumb</th>
                        <th @click="sortBy('date')" class="w-24 sortable bg-slate-50">Date {{ getSortIcon('date') }}</th>
                        <th @click="sortBy('tool')" class="w-12 sortable bg-slate-50 text-center">Tool {{ getSortIcon('tool') }}</th>
                        <th @click="sortBy('filename')" class="w-32 sortable bg-slate-50">File {{ getSortIcon('filename') }}</th>
                        <th @click="sortBy('model')" class="w-28 sortable bg-slate-50">Model / LoRA {{ getSortIcon('model') }}</th>
                        <th @click="sortBy('steps')" class="w-10 sortable bg-slate-50">Stp {{ getSortIcon('steps') }}</th>
                        <th @click="sortBy('cfg')" class="w-10 sortable bg-slate-50">CFG {{ getSortIcon('cfg') }}</th>
                        <th @click="sortBy('sampler')" class="w-20 sortable bg-slate-50">Sampler {{ getSortIcon('sampler') }}</th>
                        <th class="w-[30%] bg-slate-50">Positive Prompt <span class="text-[9px] normal-case font-normal ml-1 text-slate-400">(Click to Filter, Pencil to Edit)</span></th>
                        <th class="w-[15%] bg-slate-50">Negative</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    <tr v-for="img in filteredImages" :key="img.id" :class="{'bg-blue-50': img.isSelected, 'hover:bg-slate-50': !img.isSelected}">
                        <td class="text-center align-middle"><input type="checkbox" v-model="img.isSelected" class="w-4 h-4 rounded text-blue-600"></td>
                        <td class="text-center align-middle">
                            <div @click="toggleFav(img)" class="fav-btn">
                                <span v-if="!img.fav" class="fav-none">‚òÜ</span>
                                <span v-else-if="img.fav==='star'" class="fav-star">‚òÖ</span>
                                <span v-else-if="img.fav==='heart'" class="fav-heart">‚ô•</span>
                                <span v-else-if="img.fav==='flag'" class="fav-flag">üö©</span>
                            </div>
                        </td>
                        <td class="align-middle p-2">
                            <div class="thumb-wrap" @mouseenter="showPreview(img, $event)" @mousemove="movePreview($event)" @mouseleave="hidePreview">
                                <a v-if="img.blobUrl" :href="img.blobUrl" target="_blank" class="w-full h-full block"><img :src="img.blobUrl" class="thumb-img" loading="lazy"></a>
                                <a v-else-if="img.thumbnail" :href="img.thumbnail" target="_blank" class="w-full h-full block"><img :src="img.thumbnail" class="thumb-img" loading="lazy"></a>
                                <div v-else class="thumb-placeholder">NO<br>IMG</div>
                            </div>
                        </td>
                        <td class="text-[10px] text-slate-500 font-mono align-middle leading-tight">{{ formatDate(img.date) }}</td>
                        <td class="text-center align-middle" :title="img.tool">
                            <span v-if="img.tool === 'ComfyUI'" class="text-lg">‚ö°</span>
                            <span v-else-if="img.tool === 'NovelAI'" class="text-lg">ü§ñ</span>
                            <span v-else class="text-lg">üñ•Ô∏è</span>
                        </td>
                        <td class="text-[10px] font-mono text-slate-500 break-all align-middle filename-cell" @click="copyText(img.filename)" title="Click to Copy Filename">{{ img.filename }}</td>
                        <td class="align-middle"><div class="font-bold text-[10px] text-slate-800 break-all">{{ img.model }}</div><div v-if="img.loras.length" class="text-[9px] text-purple-600 mt-1 leading-tight"><span v-for="l in img.loras" class="block">‚óè {{ l }}</span></div><div class="text-[9px] font-mono text-slate-400 mt-1">S:{{ img.seed }}</div></td>
                        <td class="text-xs font-mono align-middle">{{ img.steps }}</td>
                        <td class="text-xs font-mono align-middle">{{ img.cfg }}</td>
                        <td class="text-[10px] align-middle"><div class="font-medium text-slate-700 truncate" :title="img.sampler">{{ img.sampler }}</div><div class="text-slate-400 truncate" :title="img.scheduler">{{ img.scheduler }}</div></td>
                        <td class="align-top">
                            <div class="prompt-container">
                                <button v-if="!img.isEditing" @click="copyText(img.positive)" class="copy-btn-cell" title="ÂÖ®Êñá„Ç≥„Éî„Éº">üìã</button>
                                <button v-if="!img.isEditing" @click="startEdit(img)" class="edit-btn-cell" title="„Éó„É≠„É≥„Éó„Éà„ÇíÁ∑®ÈõÜ">‚úèÔ∏è</button>
                                <button v-if="img.isEditing" @click="saveEdit(img)" class="edit-btn-cell bg-green-500 text-white border-green-600 hover:bg-green-600" title="‰øùÂ≠ò">üíæ</button>
                                
                                <div v-if="!img.isEditing" class="prompt-text-area text-[10px] text-slate-700 leading-normal" :title="img.positive">
                                    <span v-for="(w, idx) in img.tags" :key="idx" @click.stop="toggleFilter('prompt', w)" class="word-btn" :class="{'active-filter': filters.prompt.include.includes(w)}">{{ w }}<span v-if="idx < img.tags.length-1" class="text-slate-300 mr-1">,</span></span>
                                </div>
                                <textarea v-else v-model="img.positive" class="w-full h-24 text-[10px] border border-blue-300 rounded p-1 focus:ring-2 focus:ring-blue-400 outline-none"></textarea>
                            </div>
                        </td>
                        <td class="align-top"><div class="prompt-container"><button @click="copyText(img.negative)" class="copy-btn-cell" title="ÂÖ®Êñá„Ç≥„Éî„Éº">üìã</button><div class="prompt-text-area text-[10px] text-red-800 leading-normal bg-red-50/30 p-1 rounded" :title="img.negative">{{ img.negative }}</div></div></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <footer class="bg-slate-800 text-slate-400 py-8 font-sans border-t-4 border-slate-600 mt-auto">
        <div class="container mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="opacity-50 grayscale hover:grayscale-0 transition duration-500">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" class="h-10 w-10">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#64748b" stroke-width="5"/>
                        <circle cx="35" cy="45" r="5" fill="#64748b"/>
                        <circle cx="65" cy="45" r="5" fill="#64748b"/>
                        <path d="M40 65 Q50 75 60 65" fill="none" stroke="#64748b" stroke-width="3" stroke-linecap="round"/>
                    </svg>
                </div>
                <div class="text-left">
                    <p class="font-bold text-slate-300 text-sm">METAComPNG <span class="text-xs font-normal text-slate-500">v29.6</span></p>
                    <p class="text-xs mt-0.5 opacity-60">ComfyUI Metadata Analyzer</p>
                </div>
            </div>
            <div class="text-xs text-center md:text-right space-y-1">
                <p>Designed for Local Use. No Server Upload.</p>
                <p class="opacity-50">Created with Gemini</p>
            </div>
        </div>
    </footer>

    <script>
        const { createApp, ref, computed, reactive, onMounted, onUnmounted, nextTick } = Vue;
        createApp({
            setup() {
                const images = ref([]);
                const isDragging = ref(false);
                const loading = ref(false);
                const processStatus = ref("");
                const errorMessage = ref("");
                const showAnalysis = ref(false);
                const tagsLimited = ref(true);
                const filterBySelection = ref(false);
                const showAllTags = ref(false); 
                const tagSearchQuery = ref("");
                const copyMessage = ref("");
                const dbInput = ref(null);
                const fileInput = ref(null);
                const folderInput = ref(null); 
                const hoverImage = reactive({ src: null, style: { top: '0px', left: '0px' } });
                const dbStatus = ref("");
                const showScrollBtn = ref(false);
                const tagFontSize = ref('sm');
                
                const filters = reactive({ 
                    prompt: { include: [], exclude: [], mode: 'and' }, 
                    model: { include: [], exclude: [], mode: 'or' }, 
                    tool: { include: [], exclude: [], mode: 'or' },
                    fav: { include: [], exclude: [], mode: 'or' },
                    sampler: { include: [], exclude: [], mode: 'or' }, 
                    scheduler: { include: [], exclude: [], mode: 'or' }, 
                    lora: { include: [], exclude: [], mode: 'and' } 
                });
                const sortState = reactive({ key: 'date', asc: false });

                const handleScroll = () => { showScrollBtn.value = window.scrollY > 300; };
                const scrollToTop = () => { window.scrollTo({ top: 0, behavior: 'smooth' }); };
                onMounted(() => window.addEventListener('scroll', handleScroll));
                onUnmounted(() => window.removeEventListener('scroll', handleScroll));

                const toggleFav = (img) => {
                    const states = [null, 'star', 'heart', 'flag'];
                    const currentIdx = states.indexOf(img.fav || null);
                    const nextIdx = (currentIdx + 1) % states.length;
                    img.fav = states[nextIdx];
                    saveToIndexedDB(img);
                };

                const startEdit = (img) => { img.isEditing = true; };
                const saveEdit = (img) => {
                    img.isEditing = false;
                    img.tags = splitToTags(img.positive); 
                    saveToIndexedDB(img);
                };

                const DB_NAME = 'MetaComPNG_DB'; const DB_VERSION = 1; const STORE_NAME = 'images'; let db = null;
                const initIndexedDB = () => new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,DB_VERSION);r.onerror=e=>rej(e);r.onsuccess=e=>{db=e.target.result;res(db);};r.onupgradeneeded=e=>{db=e.target.result;if(!db.objectStoreNames.contains(STORE_NAME))db.createObjectStore(STORE_NAME,{keyPath:'id'});};});
                const loadFromIndexedDB = async () => { 
                    if(!db) await initIndexedDB(); 
                    dbStatus.value='busy';
                    return new Promise(res=>{
                        const tx=db.transaction([STORE_NAME],'readonly');
                        const s=tx.objectStore(STORE_NAME);
                        s.getAll().onsuccess=e=>{
                            if(e.target.result && e.target.result.length>0){
                                const restored = e.target.result.map(item => ({...item, blobUrl: null, isSelected: false, isEditing: false}));
                                images.value = restored;
                                nextTick(() => { dbStatus.value=`Restored:${restored.length}`; });
                            } else { dbStatus.value=''; }
                            res();
                        };
                        s.getAll().onerror=()=>{ dbStatus.value=''; res(); };
                    }); 
                };
                const saveToIndexedDB = async (item) => { 
                    if(!db)return; 
                    const d={...item}; delete d.blobUrl; delete d.isSelected; delete d.isEditing; 
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction([STORE_NAME], 'readwrite'); 
                        const request = tx.objectStore(STORE_NAME).put(d);
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    });
                };
                const clearIndexedDB = () => { if(!db)return; const tx=db.transaction([STORE_NAME],'readwrite'); tx.objectStore(STORE_NAME).clear(); dbStatus.value=""; };

                const thumbnailQueue = []; let isGeneratingThumbs = false;
                const createThumbnail = (url) => new Promise(res=>{const i=new Image();i.onload=()=>{const c=document.createElement('canvas');const s=120/i.width;c.width=120;c.height=i.height*s;const x=c.getContext('2d');x.drawImage(i,0,0,c.width,c.height);res(c.toDataURL('image/jpeg',0.5));};i.onerror=()=>res(null);i.src=url;}); 
                const processThumbnailQueue = async () => { 
                    if(isGeneratingThumbs||!thumbnailQueue.length)return; 
                    isGeneratingThumbs=true; 
                    let generated = 0;
                    while(thumbnailQueue.length){
                        const i=thumbnailQueue.shift();
                        if(!i.thumbnail && i.blobUrl){
                            try{
                                const thumbnailData = await createThumbnail(i.blobUrl);
                                if (thumbnailData) {
                                    i.thumbnail = thumbnailData;
                                    const imgIndex = images.value.findIndex(img => img.id === i.id);
                                    if (imgIndex !== -1) images.value[imgIndex].thumbnail = thumbnailData;
                                    await saveToIndexedDB(i); 
                                    generated++;
                                }
                                dbStatus.value=`Caching...(${thumbnailQueue.length})`;
                            }catch(e){}
                            await new Promise(r=>setTimeout(r,50));
                        }
                    } 
                    dbStatus.value="Cached"; 
                    isGeneratingThumbs=false; 
                };

                const cleanTag = (w) => { if (!w) return ""; let t = w.replace(/\\\(/g, '__L__').replace(/\\\)/g, '__R__'); t = t.replace(/[\(\)]/g, '').replace(/:\d+(\.\d+)?/g, '').trim().replace(/\s+/g, '_'); return t.replace(/__L__/g, '\\(').replace(/__R__/g, '\\)'); };
                const cleanPrompt = (t) => t ? t.replace(/ +/g, ' ').replace(/^ +/gm, '').replace(/ +$/gm, '').replace(/^\s*[\r\n]/gm, '').trim() : '';
                const splitToTags = (text) => text ? text.replace(/[\r\n]+/g, ',').split(',').map(t => cleanTag(t)).filter(t => t) : [];
                const formatDate = (ts) => { if (!ts) return '-'; const d = new Date(ts); return `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; };
                const copyText = async (text) => { try { await navigator.clipboard.writeText(text); copyMessage.value = "Copied"; setTimeout(() => copyMessage.value = "", 1000); } catch(e) {} };
                const copyActiveTags = () => copyText(filters.prompt.include.join(', '));
                const showPreview = (img, e) => { const src = img.blobUrl || img.thumbnail; if (!src) return; hoverImage.src = src; movePreview(e); };
                const movePreview = (e) => { const offset = 20; let top = e.clientY + offset; let left = e.clientX + offset; if (top + 400 > window.innerHeight) top = e.clientY - 420; hoverImage.style = { top: `${top}px`, left: `${left}px` }; };
                const hidePreview = () => { hoverImage.src = null; };

                function resolveValue(d,v,k='seed'){if(Array.isArray(v)&&v.length===2){const n=d[String(v[0])];if(n&&n.inputs){if(n.inputs[k]!==undefined)return resolveValue(d,n.inputs[k],k);if(n.inputs['seed_num']!==undefined)return n.inputs['seed_num'];for(const x in n.inputs){const y=n.inputs[x];if((typeof y==='number'||typeof y==='string')&&!isNaN(Number(y))&&String(y).length>5)return y;}}}return v;}
                function parseComfyTrace(s,f){try{const d=JSON.parse(s);let m={id:Math.random().toString(36),filename:f.name,date:f.lastModified,size:f.size,tool:'ComfyUI',fav:null,blobUrl:null,thumbnail:null,isSelected:false,isEditing:false,model:'-',loras:[],seed:'-',steps:'-',cfg:'-',sampler:'-',scheduler:'-',positive:'',negative:'',tags:[]};const all=Object.values(d);let ms=null;for(const n of all){const i=n.inputs||{};if(i.steps&&i.cfg){ms=n;break;}}if(ms){const i=ms.inputs;m.steps=i.steps;m.cfg=i.cfg;m.sampler=i.sampler_name;m.scheduler=i.scheduler;m.seed=resolveValue(d,i.seed,'seed');if(!m.seed&&m.seed!==0)m.seed=resolveValue(d,i.noise_seed,'seed');if(!m.seed&&m.seed!==0)m.seed=resolveValue(d,i.seed_num,'seed');}all.forEach(n=>{const i=n.inputs||{};for(const k in i){const v=i[k];if(typeof v==='string'){if(v.endsWith('.safetensors')||v.endsWith('.ckpt')){if(k==='ckpt_name')m.model=v;else if(k.toLowerCase().includes('lora'))m.loras.push(v);else if(m.model==='-')m.model=v;}}}});const tc=[];all.forEach(n=>{const i=n.inputs||{};['text','text_g','text_l','string','prompt'].forEach(k=>{if(i[k]&&typeof i[k]==='string'&&!i[k].endsWith('.safetensors')&&i[k].length>5)tc.push(i[k]);});});const ut=[...new Set(tc)].sort((a,b)=>b.length-a.length);if(ut.length>0)m.positive=cleanPrompt(ut[0]);if(ut.length>1)m.negative=cleanPrompt(ut[1]);if(m.model!=='-')m.model=m.model.replace(/\\/g,'/').split('/').pop();m.loras=m.loras.map(l=>l.replace(/\\/g,'/').split('/').pop());m.tags=splitToTags(m.positive);return m;}catch(e){return null;}}
                function parseSDMetadata(t,f){try{let m={id:Math.random().toString(36),filename:f.name,date:f.lastModified,size:f.size,tool:'WebUI',fav:null,blobUrl:null,thumbnail:null,isSelected:false,isEditing:false,model:'-',loras:[],seed:'-',steps:'-',cfg:'-',sampler:'-',scheduler:'-',positive:'',negative:'',tags:[]};const p=t.split('Negative prompt:');m.positive=cleanPrompt(p[0]);let r='';if(p.length>1){const s=p[1].split('Steps:');m.negative=cleanPrompt(s[0]);r='Steps:'+(s[1]||'');}else{const p2=t.split('Steps:');if(p2.length>1)r='Steps:'+p2[1];}const g=(k)=>{const reg=new RegExp(k+': ([^,]+)');const ma=r.match(reg);return ma?ma[1].trim():'-';};m.steps=g('Steps');m.sampler=g('Sampler');m.cfg=g('CFG scale');m.seed=g('Seed');m.model=g('Model');const lm=m.positive.match(/<lora:([^:>]+):/g);if(lm)m.loras=lm.map(x=>x.slice(6,-1));m.tags=splitToTags(m.positive);return m;}catch(e){return null;}}
                function parseNovelAIMetadata(s,f){try{const d=JSON.parse(s);if(!d.prompt&&!d.uc)return null;let m={id:Math.random().toString(36),filename:f.name,date:f.lastModified,size:f.size,tool:'NovelAI',fav:null,blobUrl:null,thumbnail:null,isSelected:false,isEditing:false,model:'NovelAI',loras:[],seed:'-',steps:'-',cfg:'-',sampler:'-',scheduler:'-',positive:'',negative:'',tags:[]};m.positive=cleanPrompt(d.prompt||'');m.negative=cleanPrompt(d.uc||'');m.steps=d.steps||'-';m.seed=d.seed||'-';m.sampler=d.sampler||'-';m.cfg=d.scale||d.strength||'-';if(d.model)m.model=d.model;m.tags=splitToTags(m.positive);return m;}catch(e){return null;}}
                async function extractAndParse(f){return new Promise((res)=>{const r=new FileReader();r.onload=(e)=>{try{const b=e.target.result;const v=new DataView(b);if(v.getUint32(0)!==0x89504E47){res(null);return;}let o=8;while(o<v.byteLength){const l=v.getUint32(o);const t=String.fromCharCode(v.getUint8(o+4),v.getUint8(o+5),v.getUint8(o+6),v.getUint8(o+7));if(t==='tEXt'||t==='iTXt'){const cd=new Uint8Array(b,o+8,l);const txt=new TextDecoder('utf-8').decode(cd);if(txt.startsWith('Comment\0')||txt.startsWith('Description\0')){const c=txt.replace(/^(Comment|Description)\0/,'');const idx=c.indexOf('{');if(idx!==-1){const r=parseNovelAIMetadata(c.substring(idx),f);if(r){res(r);return;}}}if(txt.includes('{"')||txt.includes('prompt')){const idx=txt.indexOf('{');if(idx!==-1){const j=txt.substring(idx);try{const p=JSON.parse(j);if(Object.values(p).some(x=>x.class_type||x.inputs)){const r=parseComfyTrace(j,f);if(r){res(r);return;}}}catch(err){}}}if(txt.startsWith('parameters\0')||txt.includes('Negative prompt:')||txt.includes('Steps:')){const c=txt.replace(/^parameters\0/,'');const r=parseSDMetadata(c,f);if(r){res(r);return;}}}o+=12+l;}res(null);}catch(err){res(null);}};r.readAsArrayBuffer(f);});}

                // --- Improved Folder & Recursion Logic (v29.6) ---
                let scannedCount = 0;
                
                const scanFiles = async (entry) => {
                    if (entry.isFile) {
                        scannedCount++;
                        if (scannedCount % 20 === 0) processStatus.value = `Êé¢Á¥¢‰∏≠: ${scannedCount}„Éï„Ç°„Ç§„É´`;
                        return new Promise(resolve => {
                            entry.file(f => resolve([f]), err => resolve([])); 
                        });
                    } else if (entry.isDirectory) {
                        if (['.git', 'node_modules', '$RECYCLE.BIN', 'System Volume Information', '__MACOSX'].includes(entry.name)) {
                            return [];
                        }
                        const reader = entry.createReader();
                        let entries = [];
                        const readAllEntries = async () => {
                            try {
                                const batch = await new Promise((res, rej) => reader.readEntries(res, rej));
                                if (batch.length === 0) return;
                                entries = entries.concat(batch);
                                await readAllEntries();
                            } catch (e) { console.warn(`Skipped: ${entry.name}`, e); }
                        };
                        await readAllEntries();
                        if (entries.length > 100) await new Promise(r => setTimeout(r, 0));
                        const results = await Promise.all(entries.map(scanFiles));
                        return results.flat();
                    }
                    return [];
                };

                const processFiles = async (items, isScan = false) => {
                    loading.value = true; 
                    errorMessage.value = "";
                    scannedCount = 0;
                    processStatus.value = "Ë™≠„ÅøËæº„ÅøÈñãÂßã...";
                    
                    try {
                        let flatFiles = [];
                        
                        // Robust Hybrid Loading Logic (v29.6)
                        if (isScan && items) {
                             // Use Scan Logic for Folders
                            for (let i = 0; i < items.length; i++) {
                                const item = items[i];
                                if (item.webkitGetAsEntry) {
                                    const entry = item.webkitGetAsEntry();
                                    if (entry) {
                                        const files = await scanFiles(entry);
                                        flatFiles = flatFiles.concat(files);
                                    }
                                } else if (item.kind === 'file') {
                                    const f = item.getAsFile();
                                    if(f) flatFiles.push(f);
                                }
                            }
                        } else {
                            // Use Standard File API (Legacy Mode: Fast & Safe)
                            flatFiles = Array.from(items);
                        }

                        const pngFiles = flatFiles.filter(f => f.type === 'image/png' || f.name.toLowerCase().endsWith('.png'));
                        const jsonFiles = flatFiles.filter(f => f.type === 'application/json' || f.name.toLowerCase().endsWith('.json'));
                        
                        if (!pngFiles.length && !jsonFiles.length) { 
                            throw new Error(`ÂØæË±°„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü (Scan: ${flatFiles.length} files)`);
                        }

                        const newImages = [];
                        
                        // Process JSON
                        for (const f of jsonFiles) {
                            try { const t = await f.text(); const d = JSON.parse(t); if (Array.isArray(d)) { 
                                const r = d.map(x => ({ ...x, id: Math.random().toString(36), blobUrl: null, isSelected: false, isEditing: false, fav: x.fav||null, tags: x.tags||splitToTags(x.positive), thumbnail: x.thumbnail || null }));
                                newImages.push(...r); 
                                r.forEach(item => saveToIndexedDB(item));
                            }} catch(e){}
                        }
                        
                        // Process PNGs
                        const currentMap = new Map(images.value.map(i => [i.filename, i]));
                        
                        for (let i = 0; i < pngFiles.length; i++) {
                            const file = pngFiles[i];
                            // Re-link Logic
                            if (currentMap.has(file.name)) {
                                const existing = currentMap.get(file.name);
                                const sizeMatch = (existing.size === undefined) || (existing.size === file.size);
                                const dateMatch = existing.date === file.lastModified;
                                if (dateMatch && sizeMatch) {
                                    processStatus.value = `ÂÜç„É™„É≥„ÇØ: ${i+1}/${pngFiles.length}`;
                                    if (existing.blobUrl) URL.revokeObjectURL(existing.blobUrl);
                                    existing.blobUrl = URL.createObjectURL(file);
                                    if (existing.size === undefined) { existing.size = file.size; saveToIndexedDB(existing); }
                                    if (!existing.thumbnail) thumbnailQueue.push(existing);
                                    continue;
                                }
                            }
                            
                            // Parse New
                            processStatus.value = `Ëß£Êûê: ${i+1}/${pngFiles.length}`;
                            const meta = await extractAndParse(file);
                            if (meta) { 
                                meta.blobUrl = URL.createObjectURL(file); 
                                newImages.push(meta); 
                                saveToIndexedDB(meta); 
                                thumbnailQueue.push(meta); 
                            }
                            
                            if (i % 50 === 0) await new Promise(r => setTimeout(r, 0));
                        }
                        
                        if (newImages.length > 0) {
                            const updatedNames = new Set(newImages.map(i => i.filename));
                            const keptImages = images.value.filter(i => !updatedNames.has(i.filename));
                            images.value = [...keptImages, ...newImages];
                        }
                        
                        processThumbnailQueue();

                    } catch (err) {
                        console.error(err);
                        errorMessage.value = err.message || "Ë™≠„ÅøËæº„Åø‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü";
                    } finally {
                        loading.value = false;
                        processStatus.value = "";
                    }
                };

                const handleDrop = async (e) => { 
                    isDragging.value = false;
                    
                    // Hybrid Detection (v29.6)
                    const droppedFiles = Array.from(e.dataTransfer.files);
                    const items = e.dataTransfer.items;
                    let hasFolder = false;
                    
                    if (items) {
                        for (let i = 0; i < items.length; i++) {
                            const item = items[i];
                            const entry = item.webkitGetAsEntry ? item.webkitGetAsEntry() : null;
                            if (entry && entry.isDirectory) {
                                hasFolder = true;
                                break;
                            }
                        }
                    }

                    if (hasFolder) {
                        // Use Folder Scan Logic
                        await processFiles(items, true); 
                    } else {
                        // Use Standard File Logic (Legacy, Safe)
                        await processFiles(droppedFiles, false);
                    }
                };
                
                const triggerFileSelect = () => fileInput.value.click();
                const triggerFolderSelect = () => folderInput.value.click(); 
                const handleFiles = async (e) => { await processFiles(e.target.files, false); e.target.value = ''; };
                
                const saveDB = async () => {
                    const targets = filteredImages.value;
                    if(!targets.length)return;
                    if(!confirm(`${targets.length}‰ª∂„Çí‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü`))return;
                    loading.value = true;
                    const dbData = [];
                    for(let i=0;i<targets.length;i++){
                        processStatus.value=`‰øùÂ≠òÊ∫ñÂÇô: ${i+1}`;
                        const img = targets[i];
                        const d = {...img};
                        delete d.id; delete d.blobUrl; delete d.isSelected; delete d.isEditing;
                        if(!d.thumbnail && img.blobUrl) d.thumbnail = await createThumbnail(img.blobUrl);
                        dbData.push(d);
                    }
                    const b=new Blob([JSON.stringify(dbData)],{type:"application/json"});
                    const l=document.createElement("a");l.href=URL.createObjectURL(b);l.download=`comfy_db_${new Date().toISOString().slice(0,10)}.json`;document.body.appendChild(l);l.click();document.body.removeChild(l);
                    loading.value=false; processStatus.value="";
                };
                
                const loadDB = async (e) => processFiles(e.target.files, false);
                const triggerDbLoad = () => dbInput.value.click();
                
                const clearAll = () => { if(confirm("ÂÖ®„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")){ images.value.forEach(i => i.blobUrl && URL.revokeObjectURL(i.blobUrl)); images.value = []; resetFilters(); clearIndexedDB(); }};
                const resetFilters = () => { for(let k in filters) { filters[k].include=[]; filters[k].exclude=[]; } };
                const toggleFilter = (t, v) => { const f = filters[t]; if(f.include.includes(v)){f.include=f.include.filter(x=>x!==v);f.exclude.push(v);}else if(f.exclude.includes(v)){f.exclude=f.exclude.filter(x=>x!==v);}else{f.include.push(v);} };
                const removeFilter = (t, v, m) => { filters[t][m]=filters[t][m].filter(x=>x!==v); };
                const toggleMode = (t) => { filters[t].mode = filters[t].mode==='and'?'or':'and'; };
                const getFilterClass = (t, v) => filters[t].include.includes(v) ? (filters[t].mode==='and'?'state-include':'state-include-or') : (filters[t].exclude.includes(v)?'state-exclude':'state-off');
                const hasActiveFilters = computed(() => Object.values(filters).some(f => f.include.length || f.exclude.length));
                
                const filteredImages = computed(() => {
                    let r = images.value;
                    if(filterBySelection.value) r = r.filter(i => i.isSelected);
                    if(hasActiveFilters.value) {
                        r = r.filter(img => {
                            const ft = filters.tool; if(ft.include.length && !ft.include.includes(img.tool))return false; if(ft.exclude.includes(img.tool))return false;
                            const ff = filters.fav; if(ff.include.length && !ff.include.includes(img.fav))return false; if(ff.exclude.includes(img.fav))return false;
                            const fm = filters.model; if(fm.include.length && !fm.include.includes(img.model))return false; if(fm.exclude.includes(img.model))return false;
                            const fl = filters.lora; if(fl.include.length){const m=fl.mode==='and'?fl.include.every(v=>img.loras.includes(v)):fl.include.some(v=>img.loras.includes(v));if(!m)return false;} if(fl.exclude.some(v=>img.loras.includes(v)))return false;
                            const fp = filters.prompt; if(fp.include.length){const m=fp.mode==='and'?fp.include.every(t=>img.tags.includes(t)):fp.include.some(t=>img.tags.includes(t));if(!m)return false;} if(fp.exclude.some(t=>img.tags.includes(t)))return false;
                            return true;
                        });
                    }
                    if(sortState.key) {
                        r = [...r].sort((a,b) => {
                            let va=a[sortState.key], vb=b[sortState.key];
                            if(['steps','cfg','seed','date'].includes(sortState.key)){va=Number(va)||0;vb=Number(vb)||0;}else{va=String(va).toLowerCase();vb=String(vb).toLowerCase();}
                            return (va<vb?-1:1)*(sortState.asc?1:-1);
                        });
                    }
                    return r;
                });

                const createCounts = (s,k,arr=false) => { const c={}; s.forEach(i=>{if(arr)i[k].forEach(v=>{if(v)c[v]=(c[v]||0)+1});else if(i[k]&&i[k]!=='-')c[i[k]]=(c[i[k]]||0)+1}); return Object.entries(c).map(([n,count])=>({name:n,count})).sort((a,b)=>b.count-a.count); };
                const metadataLists = computed(() => ({ tool: createCounts(filteredImages.value, 'tool'), model: createCounts(filteredImages.value, 'model'), lora: createCounts(filteredImages.value, 'loras', true), sampler: createCounts(filteredImages.value, 'sampler'), scheduler: createCounts(filteredImages.value, 'scheduler') }));
                const tagList = computed(() => { const c={}; const t=(showAllTags.value||tagSearchQuery.value)?images.value:filteredImages.value; t.forEach(i=>i.tags.forEach(x=>c[x]=(c[x]||0)+1)); return Object.entries(c).map(([w,count])=>({word:w,count})).sort((a,b)=>b.count-a.count); });
                const visibleTags = computed(() => { let l=tagList.value; if(tagSearchQuery.value){const q=tagSearchQuery.value.toLowerCase();l=l.filter(t=>t.word.toLowerCase().includes(q));}else if(tagsLimited.value){l=l.slice(0,100);} return l; });
                const selectedCount = computed(() => images.value.filter(i => i.isSelected).length);
                const isAllSelected = computed(() => filteredImages.value.length > 0 && filteredImages.value.every(i => i.isSelected));
                const toggleAllSelection = (e) => filteredImages.value.forEach(img => img.isSelected = e.target.checked);
                const copySelected = async () => { const targets = images.value.filter(i => i.isSelected); if (!targets.length) return; const text = targets.map(img => `File: ${img.filename}\nTool: ${img.tool}\nModel: ${img.model}\nSeed: ${img.seed}\nPrompt: ${img.positive}\nNegative: ${img.negative}\n---`).join('\n'); copyText(text); };
                const exportCSV = () => { const bom = new Uint8Array([0xEF, 0xBB, 0xBF]); let csv = "Filename,Tool,Fav,Date,Model,LoRA,Seed,Steps,CFG,Sampler,Positive,Negative\n"; filteredImages.value.forEach(img => { csv += [ img.filename, img.tool, img.fav||'', formatDate(img.date), img.model, img.loras.join('|'), img.seed, img.steps, img.cfg, img.sampler, `"${(img.positive||'').replace(/"/g, '""')}"`, `"${(img.negative||'').replace(/"/g, '""')}"` ].join(",") + "\n"; }); const blob = new Blob([bom, csv], { type: "text/csv;charset=utf-8;" }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "metadata.csv"; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
                const exportSelectedCSV = () => { /* Similar logic */ };
                const sortBy = (key) => { if (sortState.key === key) sortState.asc = !sortState.asc; else { sortState.key = key; sortState.asc = true; } };
                const getSortIcon = (key) => sortState.key!==key ? '‚Üï' : (sortState.asc ? '‚ñ≤' : '‚ñº');
                
                const debugIndexedDB = async () => {
                    if (!db) { console.error('DB Not Init'); return; }
                    const tx = db.transaction([STORE_NAME], 'readonly');
                    const store = tx.objectStore(STORE_NAME);
                    const allData = await new Promise((resolve) => {
                        const request = store.getAll();
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => resolve([]);
                    });
                    const withoutThumbnail = allData.filter(i => !i.thumbnail);
                    alert(`IndexedDB Debug\nTotal: ${allData.length}\nNoThumb: ${withoutThumbnail.length}`);
                };

                onMounted(async () => { await loadFromIndexedDB(); });

                return { images, isDragging, loading, processStatus, errorMessage, showAnalysis, tagsLimited, filterBySelection, selectedCount, isAllSelected, copyMessage, handleDrop, clearAll, tagList, visibleTags, metadataLists, filters, hasActiveFilters, toggleFilter, removeFilter, resetFilters, getFilterClass, filteredImages, sortBy, getSortIcon, toggleAllSelection, copySelected, exportCSV, exportSelectedCSV, toggleMode, formatDate, splitToTags, showAllTags, tagSearchQuery, copyText, copyActiveTags, dbInput, saveDB, loadDB, triggerDbLoad, hoverImage, showPreview, movePreview, hidePreview, fileInput, triggerFileSelect, handleFiles, dbStatus, showScrollBtn, scrollToTop, toggleFav, startEdit, saveEdit, tagFontSize, debugIndexedDB, folderInput, triggerFolderSelect };
            }
        }).mount('#app');
    </script>
</body>
</html>